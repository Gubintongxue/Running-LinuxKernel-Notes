### 14.3 虚拟文件系统层

虚拟文件系统（VFS）为不同的文件系统提供统一的接口和抽象层，使得用户和应用程序能够通过标准系统调用（如 `open()`、`read()`、`write()` 等）与底层文件系统交互，而无需关心具体的文件系统类型（如 `ext4`、`xfs`、`FAT32` 等）。VFS 在 Linux 内核中实现了面向对象的思想，主要包含四类对象：文件对象、超级块对象、inode 对象和目录项对象。

#### 1. 文件对象

文件对象表示打开的文件实例，由系统调用 `open()` 创建，并由 `close()` 释放。文件对象在内核中以 `struct file` 数据结构表示，包含了文件路径、文件描述符、文件的操作方法集等信息。

- **主要成员**：
  - `f_path`：文件的路径。
  - `f_inode`：文件对应的 inode。
  - `f_op`：文件的操作方法集。
  - `f_pos`：文件当前的偏移量，支持文件的随机访问。
  - `f_flags` 和 `f_mode`：分别表示文件的标志位和访问模式。
- **常见方法集（`struct file_operations`）**：
  - `read` 和 `write`：读取和写入文件内容。
  - `llseek`：更新文件偏移量。
  - `mmap`：将文件内容映射到进程地址空间。
  - `poll`：查询设备状态，适用于阻塞式 I/O 操作。
  - `fsync`：确保页面缓存内容同步到磁盘。

#### 2. 超级块对象

超级块对象代表了挂载的文件系统实例，使用 `struct super_block` 描述。超级块包含文件系统的元数据信息，如块大小、文件系统类型、最大文件大小等。

- **主要成员**：
  - `s_blocksize`：块的大小。
  - `s_type`：文件系统类型。
  - `s_op`：超级块的操作方法集。
  - `s_magic`：文件系统的标识符，通常称为魔数。
  - `s_root`：文件系统的根目录。
  - `s_count`：超级块的引用计数，表示有多少进程引用该文件系统。
  - `s_bdev`：文件系统对应的块设备。
- **常见方法集（`struct super_operations`）**：
  - `alloc_inode` 和 `destroy_inode`：分配和销毁 inode 对象。
  - `sync_fs`：将文件系统内容同步到磁盘。
  - `statfs`：获取文件系统的状态信息。
  - `remount_fs` 和 `umount_begin`：重新挂载文件系统和开始卸载文件系统。

#### 3. inode 对象

inode 是文件的核心数据结构，包含文件的元数据（如大小、权限、时间戳等）以及指向数据块的指针。每个文件和目录都对应一个 inode，使用 `struct inode` 数据结构表示。

- **主要成员**：
  - `i_mode`：文件的访问权限。
  - `i_uid` 和 `i_gid`：文件所有者的用户 ID 和组 ID。
  - `i_size`：文件大小。
  - `i_blocks`：文件占用的块数。
  - `i_op`：inode 的操作方法集。
  - `i_mapping`：文件的数据映射，指向文件的页缓存。
  - `i_atime`、`i_mtime`、`i_ctime`：文件的访问时间、修改时间和状态改变时间。
- **常见方法集（`struct inode_operations`）**：
  - `lookup`：在目录中查找 inode。
  - `create` 和 `mkdir`：创建文件和目录。
  - `unlink` 和 `rmdir`：删除文件和目录。
  - `symlink` 和 `link`：创建符号链接和硬链接。
  - `rename`：重命名文件或目录。

#### 4. 目录项对象

目录项对象（dentry）表示文件系统中的路径组件，如文件或目录的名称和层次结构，目录项包含目录树的层次结构信息，便于路径查找。每个目录项由 `struct dentry` 数据结构表示，并使用散列表（哈希表）管理目录项缓存。

- **主要成员**：
  - `d_name`：目录项的名称。
  - `d_inode`：目录项关联的 inode。
  - `d_parent`：父目录项。
  - `d_op`：目录项的操作方法集。
  - `d_count`：引用计数。
- **常见方法集（`struct dentry_operations`）**：
  - `d_revalidate`：重新验证目录项的有效性。
  - `d_delete`：删除目录项。
  - `d_release`：释放目录项资源。

### VFS 的工作原理

VFS 通过通用接口和数据结构，将不同的文件系统抽象成统一的模型。用户对文件的操作（如打开、读写、关闭）经过系统调用层处理后，会交由 VFS 进行操作。VFS 层通过 `file_operations`、`super_operations`、`inode_operations` 和 `dentry_operations` 等方法集，结合各个文件系统的具体实现来完成用户请求，实现文件系统的多态支持。