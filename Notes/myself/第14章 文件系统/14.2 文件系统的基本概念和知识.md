### 14.2 文件系统的基本概念和知识

在这一节中，我们介绍文件系统的基础知识与布局管理，以 `ext2` 文件系统为例，了解文件和目录的存储结构、磁盘空间管理等内容。

#### 14.2.1 文件系统的布局

文件系统通常安装在磁盘分区上。一个磁盘可以被分成多个分区，每个分区可以包含不同类型的文件系统（如 `ext2`、`ext4` 等）。一个标准磁盘的基本布局包括：

- **MBR（主引导记录）**：位于第0号扇区，包含启动程序，用于引导系统。
- **分区表**：记录磁盘分区的起始和结束位置。
- **分区**：包含文件系统，用于实际的数据存储。

#### 文件系统分区布局

在文件系统分区中，操作系统将磁盘的最小操作单位视为块（block），而文件系统需要有效地管理这些块。在 `ext2` 文件系统中，典型布局包括以下几个部分：

1. **超级块（superblock）**：记录文件系统的总体信息，如块数量、inode数量、空闲块数量等，是文件系统的核心元数据。
2. **组描述符（Group Descriptor）**：用于描述每个块组的信息，如块位图位置、inode位图位置、inode表的起始位置等。
3. **块位图和 inode 位图**：分别记录哪些数据块和哪些 inode 已被分配或仍为空闲。
4. **inode 表**：保存文件和目录的 inode，记录每个文件或目录的元数据信息。
5. **数据块区域**：存储文件和目录的数据内容。

以下是各主要数据结构的介绍：

- **inode**：每个文件或目录对应一个 inode，包含文件大小、所有者、权限等信息。结构定义在 `fs/ext2/ext2.h` 文件中，主要成员包括：
  - `i_data`：指向文件数据块的指针。
  - `i_flags`：文件标志。
  - `i_frag_no` 和 `i_frag_size`：碎片信息。
- **组描述符**：用于记录文件系统分区中每个组的状态，定义在 `struct ext2_group_desc` 中，主要成员包括：
  - `bg_block_bitmap`：块位图位置。
  - `bg_inode_bitmap`：inode位图位置。
  - `bg_free_blocks_count` 和 `bg_free_inodes_count`：空闲块和空闲 inode 的数量。
- **超级块**：文件系统的核心元数据块，包含文件系统的基本信息，定义在 `struct ext2_super_block` 中，主要成员包括：
  - `s_inodes_count`：inode的总数量。
  - `s_blocks_count`：块的总数量。
  - `s_free_blocks_count` 和 `s_free_inodes_count`：空闲块和空闲 inode 的数量。
  - `s_magic`：文件系统标识符（`ext2` 的魔数为 0xEF53）。
  - `s_mtime` 和 `s_wtime`：最后挂载和写入的时间。

这种结构使文件系统能够有条理地管理磁盘上的数据和元数据，通过 inode 表、块位图和超级块等元数据，操作系统可以快速地进行文件的创建、读取和删除操作，并在整个磁盘分区上高效地管理空闲块。

### 14.2.2 索引数据块

在文件系统中，关键任务之一是有效分配和索引数据块的位置。`ext2` 文件系统使用直接指针和多级间接指针来管理数据块索引，以支持不同大小的文件：

- **直接指针**：`ext2` 的 `inode` 中包含 12 个直接指针，每个直接指针指向一个数据块，适用于小文件。这 12 个直接指针可以索引总共 `12 × 4KB = 48KB` 的文件数据。

- **一级间接指针**：当文件超出直接指针的容量，`ext2` 采用一级间接指针，即 `inode` 的某个指针指向一个包含 1024 个指针的块，每个指针指向一个数据块，支持更大的文件。

- 二级和三级间接指针

  ：如果一级间接指针仍无法支持文件大小，

  ```
  ext2
  ```

   还提供二级和三级间接指针，分别通过指针的多级跳转来支持极大的文件存储空间。每增加一层指针级别，支持的文件大小会显著增加。例如：

  - 一级间接索引支持约 `4 MB` 文件。
  - 二级间接索引支持约 `4 GB` 文件。
  - 三级间接索引进一步扩展文件大小限制。

这种索引结构能高效地支持从小文件到大文件的管理。

### 14.2.3 管理空闲块

管理磁盘中的空闲块是文件系统的重要功能。`ext2` 使用位图记录空闲和已使用的块状态。当分配一个新文件时，文件系统会先分配一个 `inode`，然后通过块位图查找空闲块，并为该 `inode` 分配存储空间。`ext2` 提供 `ext2_get_block()` 函数来分配空闲块并建立映射关系。

现代文件系统如 `ext4` 使用 B 树来组织空闲块信息，进一步提高了查找效率，尤其是在大文件系统中。

### 14.2.4 高速缓存

文件系统通常会缓存文件和目录的信息以减少磁盘 I/O，提高性能。Linux 系统采用页面缓存（page cache）和缓冲区缓存（buffer cache），如下所示：

- **页面缓存**：用于缓存文件的数据内容，避免多次读取同一数据块。
- **缓冲区缓存**：用于缓存文件元数据和目录项信息。

文件系统在访问 `inode` 或 `dentry`（目录项）时，首先检查缓存，避免重复的磁盘 I/O 操作。Linux 内核通过散列表（哈希表）缓存 `inode` 和 `dentry`，并通过基数树（radix tree）管理页面缓存。这样，大幅减少了磁盘访问延迟并提升了系统的响应速度。